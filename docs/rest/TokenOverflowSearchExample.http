# Example of setting up new search parameters, running reindex, and using the new search parameters.

@hostname = localhost:44348

### 1. Test rest client
https://{{hostname}}/metadata

### 2. Get the bearer token, if authentication is enabled
# @name bearer
POST https://{{hostname}}/connect/token
content-type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id=globalAdminServicePrincipal
&client_secret=globalAdminServicePrincipal
&scope=fhir-api

### 3. POST new patient A with token overflow
# @name patient
POST https://{{hostname}}/Patient
content-type: application/json
Authorization: Bearer {{bearer.response.body.access_token}}

< .\Data\PatientAWithTokenOverflow.json

### 4. Create composite custom token-string search parameter (this test data requires R4 or higher).
POST https://{{hostname}}/SearchParameter
content-type: application/json
Authorization: Bearer {{bearer.response.body.access_token}}

< .\Data\CompositeCustomTokenStringSearchParameter.json

### 5. POST new patient B with token overflow AND non-overflow portion equal to patient A.
# @name patient
POST https://{{hostname}}/Patient
content-type: application/json
Authorization: Bearer {{bearer.response.body.access_token}}

< .\Data\PatientBWithTokenOverflow.json

### 6. POST new patient C with NO token overflow AND token size equal to max non-overflow size AND equal to patients A and B.
# @name patient
POST https://{{hostname}}/Patient
content-type: application/json
Authorization: Bearer {{bearer.response.body.access_token}}

< .\Data\PatientCWithNoTokenOverflow.json

### At this point we are able to correctly select all patient using token value.

### 7. Get patient A by token value.
GET https://{{hostname}}/Patient?identifier=IDKirk7890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456A
Authorization: Bearer {{bearer.response.body.access_token}}

### 8. Get patient B by token value.
GET https://{{hostname}}/Patient?identifier=IDKirk7890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456B
Authorization: Bearer {{bearer.response.body.access_token}}

### 9. Get patient C by token value.
GET https://{{hostname}}/Patient?identifier=IDKirk7890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456
Authorization: Bearer {{bearer.response.body.access_token}}

### At this point we can not get any patient by token-string value without using x-ms-use-partial-indices header.

### 10. Get patient B by token-string value, returns OperationOutcome warning.
GET https://{{hostname}}/Patient?identifier-name-family=IDKirk7890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456B$KirkB
Authorization: Bearer {{bearer.response.body.access_token}}

### With x-ms-use-partial-indices header we get patients B and C but not A.

### 11. Get patient A by token-string value, returns nothing.
GET https://{{hostname}}/Patient?identifier-name-family=IDKirk7890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456A$KirkA
Authorization: Bearer {{bearer.response.body.access_token}}
x-ms-use-partial-indices: true

### 12. Get patient B by token-string value.
GET https://{{hostname}}/Patient?identifier-name-family=IDKirk7890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456B$KirkB
Authorization: Bearer {{bearer.response.body.access_token}}
x-ms-use-partial-indices: true

### 13. Get patient C by token-string value.
GET https://{{hostname}}/Patient?identifier-name-family=IDKirk7890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456$KirkC
Authorization: Bearer {{bearer.response.body.access_token}}
x-ms-use-partial-indices: true

###  14. Reindex DB.
# @name reindex
POST https://{{hostname}}/$reindex
content-type: application/json
Authorization: Bearer {{bearer.response.body.access_token}}

{
  "resourceType": "Parameters",
  "parameter": [
    {
      "name": "maximumConcurrency",
      "valueInteger": "3"
    },
    {
      "name": "targetDataStoreUsagePercentage",
      "valueInteger": "80"
    },
    {
      "name": "queryDelayIntervalInMilliseconds",
      "valueInteger": "500"
    },
    {
      "name": "maximumNumberOfResourcesPerQuery",
      "valueInteger": "5"
    }
  ]
}

### 15. Check the status of your reindex job.
GET {{reindex.response.headers.Content-Location}}
Authorization: Bearer {{bearer.response.body.access_token}}

### At this point we are able to correctly select all patients using composite search value, no need for x-ms-use-partial-indices header.

### 16. Get patient A by token-string value.
GET https://{{hostname}}/Patient?identifier-name-family=IDKirk7890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456A$KirkA
Authorization: Bearer {{bearer.response.body.access_token}}

### 17. Try to get patient with incorrect token string combination, returns nothing.
GET https://{{hostname}}/Patient?identifier-name-family=IDKirk7890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456A$KirkB
Authorization: Bearer {{bearer.response.body.access_token}}
